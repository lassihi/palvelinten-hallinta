# Harjoitus 5: Miniprojekti
Kurssi: https://terokarvinen.com/palvelinten-hallinta/ \
Tehtävänanto: https://terokarvinen.com/palvelinten-hallinta/#h4-pkg-file-service

Projektin etusivu: https://github.com/lassihi/Wazuh-salt-module

## Suoritusympäristö
Tietokone: Lenovo Legion Y540-15IRH kannettava kytkettynä langallisesti kotiverkkoon.\
-Intel Core i7-9750H\
-NVIDIA Geforce RTX 2060 6GB\
-16GB DDR4 2666MHz\
Käyttöjärjestelmä: Windows 11 23H2

## Raportti

Tarkoitus asentaa Wazuh palvelinkomponentit virtuaalikoneelle ja yhdistää Wazuh agent palvelimeen Saltin avulla.

Wazuh palvelinkomponentteihin kuuluu paketit Wazuh Indexer (vastaa datan päätelaitteilta), Wazuh Manager (vastaa datan analysoinnista, tietoturvan hallinnasta ja valvonnasta) ja Wazuh Dashboard (vastaa tiedon visualisoinnista).

### Vagrantin ja Saltin alustus

Avasin PowerShellin ja siirryin edellisissä harjoituksissa luomaani vagrant kansioon.

    cd vagrant

Muokkasin notepadilla Vagrantfilea, jonka pohjana käytin Karvisen artikkelin https://terokarvinen.com/2021/two-machine-virtual-network-with-debian-11-bullseye-and-vagrant/ Vagrantfilea.

    notepad Vagrantfile
    
![image](https://github.com/user-attachments/assets/0b7acd5c-f006-4134-9ff4-f378dd50b819)

Vagrantfile luo kaksi "ubuntu/jammy64" vagrant boxia, joista toiselle se asentaa salt-masterin ja toiselle salt-minionin. Boxille "server" vagrant asettaa resursseiksi 4096 Mt muistia ja 3 prosessoriydintä. Lisäksi avasin serverin portin 443 hostin porttiin 443, jotta Wazuh:n web-käyttöliittymään voi hallita host-laitteelta. Käyttöjärjestelmän ja resurssit valitsin Wazuh:n järjestelmävaatimusten mukaan, https://documentation.wazuh.com/current/quickstart.html.

Käynnistin boxit.

    vagrant up

Ensimmäinen boxi, server käynnistyi oikein, mutta agent ei käynnistynyt

![image](https://github.com/user-attachments/assets/11307f66-2b63-4794-bebb-1031926748db)

Virtualboxin käyttöliittymästä huomasin, että se oli saanut myös samat resurssit kuin server.

Aiemmissa tehtävissä Vagrant oli toiminut oikein pienemmillä resursseilla, joten uskoin ongelman johtuvan tästä. Agent ei myöskään vaadi yhtä paljon resursseja kuin server, joten päätin muuttaa niitä.

Poistin boxit ja avasin Vagrantfilen.

        vagrant destroy
        notepad Vagrantfile

![image](https://github.com/user-attachments/assets/ad526dc2-c850-4dc9-9830-e9f454d0d649)

Vagrantfilea muokatessani huomasin, että olin ajanut koneella server scriptin minion, masterin sijasta. Resursseja ja skriptejä muokattuani käynnistin boxit.

    vagrant up

Tällä kertaa kumpikin käynnistyi ilman virheitä. Kun kuitenkin tarkastin Virtualboxista koneiden tilat, niin huomasin, että kummallakin koneella oli agentille määrittelemäni resurssit. Tiesin entuudestaan tekemistäni testeistä, että Wazuh palvelin ei kyseisillä resursseilla edes käynnisty. Projektissä pääpaino ei ole Vagrantfilellä, joten muokkasin ne suoraan manuaalisesti oikeiksi Virtualboxin käyttöliittymästä.

![image](https://github.com/user-attachments/assets/f6686630-80af-476a-991c-2ee87d73f8e5)

Yhdistin ensiksi Salt orjana toimivaan agent koneeseen.

        vagrant ssh agent

Lisäsin masterin IP-osoitteen teidostoon `/etc/salt/minion`.

![image](https://github.com/user-attachments/assets/ea857064-2908-4026-98d6-bc6d41cc87b0)

Potkaisin Salt minionia.

        sudo systemctl restart salt-minion.service

Avasin uuden PowerShell-ikkunan ja yhdistin serveriin.

        cd vagrant
        vagrant ssh server

Hyväksyin agentin avaimen.

![image](https://github.com/user-attachments/assets/1c7eefbc-3dae-4591-b4df-c9ec6ccc6c14)

Varmistin vielä, että pystyn ajamaan Saltin avulla komentoja orjalla.

![image](https://github.com/user-attachments/assets/ec8af88e-06fc-416e-a3a5-cd9334ac818d)

Orjalta tuli vastaus, joten nyt ympäristö on valmiina tilojen ajamiseen.

### Wazuh-moduuli

#### server.sls
Wazuh-palvelinkomponenttien asennukseen on käytännössä kolme vaihtoehtoa.
1. Asentaa ja ajaa [quickstart-skripti](https://packages.wazuh.com/4.11/wazuh-install.sh) joka automatisoi jokaisen komponentin asennuksen.
    * Paras, jos haluaa asentaa kaikki komponentin samalle laitteistolle ilman suurempia kustomointeja.
2. Ajaa erikseen jokaisen komponentin asennusskripti.
    * Paras, jos haluaa asentaa komponentteja eri laitteistolle ilman suurempia kustomointeja.
3. Asentaa jokainen komponentti erikseen paketinhallinnasta ja määrittää ne keskenään yhteensopiviksi-
    * Paras, jos haluaa täyden hallinnan siitä, miten palvelin on konfiguroitu.

Päätin jatkaa ensimmäisellä vaihtoehdolla, sillä se vastaa hyvin projektin tavoitteisiin, sekä kokoon. Olisi myös mahdollista, että tulevat ohjelmistopäivitykset voisivat hajottaa itse tehdyn asennus- ja konfiguraatiotilan, kun taas Wazuh:n verkkosivuilta haettu virallinen asennuskripti todennäköisesti toimisi jatkossakin.

Loin serverillä moduulille hakemiston `/srv/salt/wazuh` ja siirryin sinne.

        sudo mkdir -p /srv/salt/wazuh
        cd /srv/salt/wazuh

Asensin micron ja asetin sen oletuseditoriksi.

        sudo apt-get install micro
        export EDITOR=micro

Loin server.sls -tilan moduuliin.

        sudoedit server.sls

![image](https://github.com/user-attachments/assets/4ba3d27b-dbed-4c57-a98e-0b0b2e3bea78)

Tiedosto...
* varmistaa, että curl on asennettuna
* hakee asennusskriptin, jos wazuh_install.sh -tiedostoa ei ole työhakemistossa
* ajaa asennusskriptin, jos `/etc/` ei sisällä jokaista tarvittavaa hakemistoa konfiguraatiotiedostoille

Tallensin tiedoston ja testasin ajaa sen paikallisesti.

        sudo salt-call --local -l info state.apply wazuh.server

![image](https://github.com/user-attachments/assets/f3598678-c3de-43d7-b409-81cff34a9e09)

Komennon tulosteesta käy ilmi, että kaksi ensimmäistä tilafunktiota (`pkg.installed`, `cmd.run`) saavutettiin, mutta viimeisen tilafunktion suorittaminen epäonnistui puuttuvien oikeuksien vuoksi. Muokkasin tämän perusteella `server.sls` -tiedostoa.

        sudoedit server.sls

![image](https://github.com/user-attachments/assets/d57dc702-0a65-4f31-ae63-a96a9929b49d)

Päivitin Saltin ajamaan asennusskriptin pääkäyttäjän oikeuksin, sekä käyttämään optiota `-a`, joka määrittää skriptin asentamaan jokaisen tarvittavan komponentin.

